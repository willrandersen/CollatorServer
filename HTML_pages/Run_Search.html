<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script type="text/javascript">
    let added_count = 0;
    let running_search = false;

    function periodic_poll(task_ID) {
        const Http = new XMLHttpRequest();
        const url = '/status_check/' + String(task_ID);
        Http.open("GET", url);
        Http.send();
        Http.onreadystatechange = function () {
            if (Http.readyState == 4 && Http.status == 200) {
                let response = Http.responseText;
                if (response.startsWith('{"status" :')) {
                    setTimeout(periodic_poll, 5000, task_ID);
                } else {
                    console.log(response);
                    const table_div = document.getElementById("table_area");
                    //let download_button = document.createElement("button");
                    table_div.insertAdjacentHTML('afterbegin', response);
                    table_div.insertAdjacentHTML('afterbegin', "<button onclick=\"window.location.href = '/download/" + task_ID + "';\">Download</button> <br><br>");
                    running_search = false;
                }
            }
        }
    }

    function submit_search() {
        if (running_search) {
            return;
        }
        running_search = true;
        const Http = new XMLHttpRequest();
        const url = '/Search';
        Http.open("POST", url);
        let form = new FormData();
        let count = 0;
        while (true) {
            if (document.getElementById("input_" + count) == null) {
                break;
            }
            form.append('search_' + count, document.getElementById("input_" + count).value);
            form.append('check_' + count, document.getElementById("check_" + count).checked);
            count++;
        }

        Http.send(form);
        Http.onreadystatechange = function () {
            if (Http.readyState == 4 && Http.status == 200) {
                let task_id = Http.responseText;
                setTimeout(periodic_poll, 3000, task_id);
            } else if (Http.readyState == 4) {
                running_search = false
            }
        }
    }

    function add_row() {
        if (running_search || added_count > 14) {
            return;
        }
        const entry_div = document.getElementById("button_area");

        var text = document.createElement("input");
        var checkbox = document.createElement("input");
        var breakrow = document.createElement("BR");
        checkbox.type = "checkbox";
        checkbox.name = "checkbox_" + added_count;
        checkbox.value = "1";
        checkbox.id = "check_" + added_count;

        text.type = "text";
        text.placeholder = "Enter SC/FO";
        text.name = "Text_Box_" + added_count;
        text.id = "input_" + added_count;

        entry_div.appendChild(text);
        entry_div.appendChild(checkbox);
        entry_div.appendChild(breakrow);
        added_count++;
    }
</script>
<h2>Enter an FO/SC/Project</h2> <br>
<p>Instructions: Each box takes an FO or an List ID. <br> If you would like to also load all other data on a project, mark the check beside the data point. <br> When completed results will be displayed below. They'll also be available on the home screen.</p><br>
<div id="button_area"></div>
<br> <button onclick='submit_search()' type="button" name="submit">Start Collator</button>
<br> <br>
<button onclick='add_row()' type="button" name="button">Add Additional Data Point</button> <br>
<div id="table_area"></div>
<script type="text/javascript">
    add_row();
</script>
</html>
