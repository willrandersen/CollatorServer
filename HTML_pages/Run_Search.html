<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Equipment Search</title>
    <meta name="format-detection" content="telephone=no">
</head>
<script type="text/javascript">
    let added_count = 0;
    let running_search = false;

    let dot_count = 1;
    function change_dots() {
        if (running_search) {
            setTimeout(change_dots, 500);
            if (dot_count == 0) {
                document.getElementById('paragraph_out').innerHTML = 'Running Search .';
                dot_count++;
            } else if (dot_count == 1) {
                document.getElementById('paragraph_out').innerHTML = 'Running Search ..';
                dot_count++;
            } else if (dot_count == 2) {
                document.getElementById('paragraph_out').innerHTML = 'Running Search ...';
                dot_count++;
            } else if (dot_count == 3) {
                document.getElementById('paragraph_out').innerHTML = 'Running Search ....';
                dot_count++;
            } else if (dot_count == 4) {
                document.getElementById('paragraph_out').innerHTML = 'Running Search ';
                dot_count = 0;
            }
        } else {
            document.getElementById('paragraph_out').innerHTML = '';
        }
    }


    function periodic_poll(task_ID) {
        const Http = new XMLHttpRequest();
        const url = '/status_check/' + String(task_ID);
        Http.open("GET", url);
        Http.send();
        Http.onreadystatechange = function () {
            if (Http.readyState == 4) {
                let response = Http.responseText;
                if (response.startsWith('{"status" :')) {
                    setTimeout(periodic_poll, 5000, task_ID);
                } else {
                    document.getElementById('paragraph_out').innerHTML = '';
                    console.log(response);
                    const table_div = document.getElementById("table_area");
                    //let download_button = document.createElement("button");
                    table_div.insertAdjacentHTML('afterbegin', response);
                    table_div.insertAdjacentHTML('afterbegin', "<button onclick=\"window.location.href = '/download/" + task_ID + "';\">Download</button> <br><br>");
                    running_search = false;
                    let add_row_button = document.getElementById("add_point_button");
                    add_row_button.disabled = false;
                }
            }
        }
    }

    function submit_search() {
        if (running_search) {
            return;
        }
        let add_row_button = document.getElementById("add_point_button");
            add_row_button.disabled = true;
        running_search = true;
        const Http = new XMLHttpRequest();
        const url = '/Search';
        Http.open("POST", url);
        let form = new FormData();
        let count = 0;
        while (true) {
            if (document.getElementById("input_" + count) == null) {
                break;
            }
            form.append('search_' + count, document.getElementById("input_" + count).value);
            form.append('check_' + count, document.getElementById("check_" + count).checked);
            count++;
        }

        Http.send(form);
        Http.onreadystatechange = function () {
            if (Http.readyState == 4 && Http.status == 202) {
                let task_id = Http.responseText;
                setTimeout(periodic_poll, 3000, task_id);
                document.getElementById('paragraph_out').innerHTML = 'Running Search .';
                setTimeout(change_dots, 500);
            } else if (Http.readyState == 4) {
                let add_row_button = document.getElementById("add_point_button");
            add_row_button.disabled = false;
                running_search = false
            }
        }
    }

    function add_row() {
        if (running_search || added_count > 14) {
            let add_row_button = document.getElementById("add_point_button");
            add_row_button.disabled = true;
            return;
        }
        const entry_div = document.getElementById("button_area");

        var text = document.createElement("input");
        var checkbox = document.createElement("input");
        var breakrow = document.createElement("BR");
        checkbox.type = "checkbox";
        checkbox.name = "checkbox_" + added_count;
        checkbox.value = "1";
        checkbox.id = "check_" + added_count;

        text.type = "text";
        text.placeholder = "Enter SC/FO";
        text.name = "Text_Box_" + added_count;
        text.id = "input_" + added_count;

        entry_div.appendChild(text);
        entry_div.appendChild(checkbox);
        entry_div.appendChild(breakrow);
        added_count++;
    }
</script>

<script type="text/javascript">
    function send_logout() {
        const Http = new XMLHttpRequest();
        let url = "/logout";
        Http.open("DELETE", url);
        Http.send();
        Http.onreadystatechange = function () {
            if (Http.readyState == 4) {
                window.location = '/'
            }
        }
    }
</script>

<h2>Enter an FO/SC/Project</h2> <br>
<p>Instructions: Each box takes an FO or a List ID. <br> If you would like to also load all other data on a project, mark the check beside the data point (This can take a few minutes).<br> When completed results will be displayed below. They'll also be available on the home screen.</p><br>
<div id="button_area"></div>
<br> <button onclick='add_row()' type="button" id="add_point_button" name="button">Add Additional Data Point</button>
<br> <br>
<button onclick='submit_search()' type="button" name="submit">Start Collator</button> <br>
<p id="paragraph_out"></p>
<div id="table_area"></div>
<br>
<br>
<button onclick="send_logout()">Log Out</button>

<script type="text/javascript">
    add_row();
</script>

</html>
